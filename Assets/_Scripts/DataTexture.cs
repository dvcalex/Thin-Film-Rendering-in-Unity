using System;
using UnityEngine;

[ExecuteAlways]
public class DataTexture : MonoBehaviour
{
    public enum Format
    {
        RGB,
        RGBA
    }

    public enum Coat
    {
        PerfectMirror,
        Coat1Layer,
        Coat4Layer,
    }
    
    public Renderer renderer;
    [SerializeField] private Coat currentCoat = Coat.PerfectMirror;
    
    private Coat lastCoat = Coat.PerfectMirror;

    private double[] coat1layer =
    {
        0.017828628328346703, 0.01782620077280887, 0.017818936600813857, 0.017806891364654978, 0.017790157880441405,
        0.017768866574442883, 0.01774318597385883, 0.01771332334803968, 0.017679525508107852, 0.01764207977500221,
        0.017601315128231675, 0.017557603550112252, 0.01751136158301582, 0.017463052120219095, 0.01741318645435059,
        0.017362326611239005, 0.017311088001216317, 0.017260142424675433, 0.017210221473981466, 0.017162120379747976,
        0.017116702356079087, 0.01707490350671533, 0.017037738362182964, 0.0170063061271146, 0.016981797726974765,
        0.016965503754588995, 0.01695882342924517, 0.01696327469483842, 0.01698050559869535, 0.017012307109494633,
        0.017060627551266055, 0.017127588850986915, 0.01721550482001894, 0.01732690171477705, 0.017464541349870157,
        0.01763144706780535, 0.0178309329035584, 0.01806663632027541, 0.018342554934543707, 0.018663087696567625,
        0.01903308104279863, 0.019457880596776098, 0.019943389058901542, 0.02049613099848463, 0.02112332534266564,
        0.021832966447900268, 0.022633914741908016, 0.02353599803885992, 0.024550124759855935, 0.025688410436428378,
        0.026964319039207235, 0.028392820859663, 0.029990568883073932, 0.03177609582909496, 0.03377003430666602,
        0.03599536283726243, 0.03847768085024448, 0.04124551615280763, 0.04433066883240702, 0.04776859607046463,
        0.051598842943233296, 0.055865524971331244, 0.060617868968456584, 0.06591081964969561, 0.07180572051159699,
        0.07837107871485038, 0.08568342511606428, 0.09382828224397419, 0.10290125494120514, 0.11300926064840902,
        0.12427191895767327, 0.13682312318508888, 0.1508128204044162, 0.16640903076288388, 0.18380014211166862,
        0.20319752220708479, 0.2248384981968268, 0.24898976207591242, 0.27595127162577937, 0.30606072947165563,
        0.3396987388548147, 0.3772947542092458, 0.4193339685343507, 0.46636530898642403, 0.5190107485058358,
        0.5779761865005835, 0.6440642080086499, 0.7181891014673841, 0.8013946042891429, 0.8948749582193181,
        0.9999999999999992, 0.019672141087613067, 0.01966902529787666, 0.01965969691764215, 0.01964421298750323,
        0.019622668821374492, 0.019595198378323554, 0.01956197478808573, 0.019523211035356564, 0.019479160809619138,
        0.01943011952908629, 0.019376425549354658, 0.019318461569620846, 0.01925665625184118, 0.019191486071068017,
        0.01912347741841417, 0.01905320898173309, 0.01898131443320656, 0.018908485457661932, 0.01883547516065534,
        0.018763101901222913, 0.01869225360078611, 0.018623892587075697, 0.018559061040193482, 0.01849888711714834,
        0.018444591841479722, 0.018397496856022395, 0.01835903314958348, 0.01833075088242494, 0.01831433045110692,
        0.018311594950605796, 0.018324524210844507, 0.018355270606051455, 0.01840617685891359, 0.018479796087544284,
        0.018578914372124652, 0.018706576149994804, 0.01886611278332658, 0.01906117468268726, 0.019295767413261198,
        0.01957429225874363, 0.019901591771546108, 0.020283000897628783, 0.02072440433076817, 0.021232300825266164,
        0.02181387527901175, 0.02247707949158703, 0.023230722606090975, 0.02408457236006652, 0.025049468402118198,
        0.026137449078516197, 0.027361893260622043, 0.02873767897202537, 0.030281360786937866, 0.032011368212222134,
        0.03394822753858289, 0.03611480995670953, 0.038536609087119485, 0.041242051474612726, 0.0442628440572289,
        0.04763436314429103, 0.051396090039038556, 0.05559209913082552, 0.0602716050745394, 0.06548957658811956,
        0.07130742545350517, 0.07779378052670867, 0.08502535797860324, 0.09308794063503296, 0.10207748120600235,
        0.11210134644098912, 0.12327972188412445, 0.13574720000617768, 0.14965457815430686, 0.16517089710117827,
        0.18248575613500723, 0.20181194678763983, 0.22338845466792476, 0.24748388772475188, 0.27440039994910337,
        0.3044781924648384, 0.3381006896925303, 0.3757005074813509, 0.417766353656854, 0.4648510304334408,
        0.5175807440065682, 0.5766659711977846, 0.6429141886397036, 0.7172448397346605, 0.8007070025256703,
        0.8945003329785013, 0.9999999999999996, 0.02988908924498443, 0.029884538547260392, 0.029870902213775426,
        0.029848227653905084, 0.02981659431787164, 0.02977611434940246, 0.029726933501027723, 0.029669232313706134,
        0.029603227563111408, 0.02952917397568673, 0.02944736621850838, 0.02935814116813236, 0.02926188046497253,
        0.029159013361418833, 0.029050019873901604, 0.028935434251502315, 0.028815848776562496, 0.028691917916124916,
        0.02856436284703131, 0.02843397638218606, 0.02830162833097074, 0.028168271333165386, 0.028034947213112043,
        0.0279027939093712, 0.027773053044906314, 0.027647078214032294, 0.027526344075140815, 0.027412456352738063,
        0.027307162868783343, 0.027212365741899187, 0.027130134913946335, 0.027062723186950792, 0.02701258297968236,
        0.026982385042580773, 0.02697503940249986, 0.026993718845204198, 0.027041885284059545, 0.027123319408286668,
        0.02724215405392439, 0.02740291179575339, 0.02761054731939553, 0.027870495200242006, 0.028188723790461882,
        0.028571795997903424, 0.02902693783212979, 0.029562115694188738, 0.030186123499216976, 0.03090868084604059,
        0.03174054358718574, 0.032693628308065846, 0.03378115239775586, 0.03501779158826908, 0.03641985705757626,
        0.03800549443718633, 0.039794907341941625, 0.04181060835238234, 0.04407770073398644, 0.046624194579022726,
        0.04948136151294431, 0.05268413262664853, 0.056271544888459216, 0.06028724196694031, 0.06478003617129632,
        0.06980453910627589, 0.07542186966229533, 0.08170044914171579, 0.0887168946860886, 0.09655702374947414,
        0.10531698419922046, 0.11510452676584054, 0.12604043906642654, 0.1382601633630949, 0.15191562367756345,
        0.16717729197426784, 0.1842365279830054, 0.2033082330269522, 0.22463386516483508, 0.24848487131316482,
        0.2751666021219786, 0.3050227876614125, 0.3384406669787601, 0.3758568829989689, 0.4177642769537504,
        0.46471974467938226, 0.5173533521991118, 0.5763789519227931, 0.6426065960578344, 0.7169571137124735,
        0.8004793070051479, 0.894370334991837, 0.9999999999999991
    };

    private double[] coat4layer =
    {
        0.0014700989531489688, 0.0014714687812553613, 0.001475585129289977, 0.0014824686132538316, 0.001492153678996269,
        0.001504688741469995, 0.0015201364006211466, 0.001538573754765263, 0.0015600928381345161, 0.0015848012150149865,
        0.0016128227684946129, 0.001644298727275993, 0.0016793889792373641, 0.001718273725406969, 0.0017611555327119483,
        0.0018082618482318192, 0.0018598480416971018, 0.0019162010465975311, 0.001977643673492387, 0.002044539671950823,
        0.0021172996200221196, 0.002196387722299866, 0.0022823295995919916, 0.002375721155065912, 0.0024772386036827675,
        0.0025876497539841716, 0.0027078266341275113, 0.00283875955781174, 0.002981572730783227, 0.003137541505410742,
        0.0033081113998757847, 0.0034949190104024185, 0.0036998149602676784, 0.003924889048750692, 0.004172497787404929,
        0.004445294540807054, 0.004746262525014176, 0.005078750960120489, 0.005446514724324869, 0.0058537579165721535,
        0.006305181803865754, 0.006806037708496637, 0.007362185480387235, 0.007980158301175856, 0.008667234680198364,
        0.009431518628775809, 0.010282029138799068, 0.011228800245143819, 0.012282993119644444, 0.013457021827985614,
        0.014764694580876472, 0.01622137252841761, 0.017844148383088804, 0.019652047414095347, 0.021666253636162147,
        0.02391036432204397, 0.02641067630343262, 0.02919650789366201, 0.03230056067251082, 0.03575932582412534,
        0.03961354022019827, 0.04390869799949028, 0.04869562401995843, 0.05403111626053929, 0.059978665036359784,
        0.06660925777516417, 0.07400227909647161, 0.08224651705187586, 0.09144128763969878, 0.10169769111587726,
        0.1131400152030696, 0.12590730207083994, 0.14015509794297804, 0.15605740640778804, 0.17380886899129344,
        0.19362719933377504, 0.2157559004246583, 0.2404672978442467, 0.2680659258874006, 0.29889230786993976,
        0.33332717692470293, 0.3717961892820699, 0.4147751885256006, 0.4627960867766014, 0.5164534373919549,
        0.5764117838110637, 0.6434138809805114, 0.7182898997240628, 0.8019677410228339, 0.8954846070720246,
        0.9999999999999994, 0.0010399550534184003, 0.0010413933326861246, 0.001045722800425235, 0.0010529873000422567,
        0.0010632597519170308, 0.0010766419349596801, 0.001093264199910408, 0.0011132851337586425, 0.001136891200545393,
        0.0011642963899364213, 0.0011957419113379593, 0.00123149597797878, 0.0012718537322945448, 0.0013171373710925286,
        0.0013676965363046503, 0.0014239090445885582, 0.0014861820365343588, 0.0015549536336870791,
        0.0016306951989043662, 0.0017139143026343184, 0.001805158504423116, 0.0019050200652593902,
        0.0020141417121681505, 0.0021332235817421072, 0.0022630314740452904, 0.0024044065525903654,
        0.002558276629983806, 0.002725669182523597, 0.002907726240767459, 0.0031057213071930536, 0.00332107845695427,
        0.003555393783900458, 0.0038104593620572995, 0.004088289903343916, 0.00439115230618625, 0.004721598307719846,
        0.005082500475372153, 0.005477091802751287, 0.005909009210973958, 0.006382341300910581, 0.006901680755407271,
        0.007472181854479297, 0.00809962364187247, 0.008790479369371315, 0.009551992946886734, 0.01039226324274985,
        0.011320337210819008, 0.012346312969982612, 0.013481454128421836, 0.014738316830573467, 0.016130891210125512,
        0.017674759158669257, 0.01938727056799101, 0.021287740475762096, 0.02339766984114445, 0.025740993000460354,
        0.02834435520588172, 0.031237424034885497, 0.034453238878477066, 0.03802860317608809, 0.04200452456975408,
        0.04642670870579285, 0.05134611302604643, 0.05681956757147026, 0.06291047057854818, 0.06968956749547038,
        0.07723582299389366, 0.0856373966191778, 0.09499273392556684, 0.10541178630397123, 0.11701737425349726,
        0.12994671060249582, 0.14435310218477418, 0.16040785076229075, 0.17830237660596268, 0.19825059116021962,
        0.22049154869698162, 0.2452924108995727, 0.27295176301676305, 0.3038033257281511, 0.3382201133345951,
        0.3766190965439273, 0.41946643722795407, 0.4672833734139362, 0.5206528458566865, 0.5802269733343242,
        0.6467355029678146, 0.7209953851872671, 0.8039216514599524, 0.8965398078049617, 0.9999999999999993,
        0.0014560357477982648, 0.001454781111846814, 0.0014510228114415803, 0.0014447777923176342,
        0.0014360747111481554, 0.0014249545648092163, 0.0014114715881113713, 0.0013956944357887465,
        0.0013777076677128702, 0.0013576135585616114, 0.0013355342544190745, 0.0013116142989582909,
        0.0012860235509833263, 0.0012589605132660151, 0.0012306560899706615, 0.001201377786762837,
        0.0011714343642722901, 0.0011411809523310563, 0.0011110246298166768, 0.001081430473538621,
        0.0010529280800085424, 0.001026118566755788, 0.0010016820657198409, 0.0009803857307859474,
        0.0009630922952897658, 0.0009507692337785533, 0.0009444986058389055, 0.0009454876885836039,
        0.0009550805384503354, 0.0009747706621001041, 0.001006215019984486, 0.0010512496339049465,
        0.0011119071207153454, 0.0011904365271108355, 0.0012893258939359437, 0.0014113280312642337,
        0.001559490036273949, 0.0017371871333754698, 0.0019481614590506399, 0.0021965664516760256, 0.002487017538909335,
        0.0028246498422713063, 0.0032151836412712687, 0.0036649983594620192, 0.004181215854611105,
        0.0047717938179758414, 0.005445630117458629, 0.006212678960875569, 0.007084079813945607, 0.008072300088599585,
        0.009191292726810515, 0.010456669949500839, 0.011885894625349995, 0.01349849094657843, 0.015316276383974335,
        0.017363617237367585, 0.01966771050624164, 0.02225889528411297, 0.025170997436020054, 0.028441711957969462,
        0.03211302814870459, 0.03623170355755038, 0.04084979361953815, 0.04602524496563608, 0.05182256162058779,
        0.0583135546970404, 0.06557818779131834, 0.07370553211891612, 0.08279484753989015, 0.09295680806817434,
        0.10431489329739702, 0.11700697048420428, 0.13118709589777441, 0.14702756857688398, 0.16472127495826427,
        0.184484369098466, 0.2065593405776353, 0.23121853084755212, 0.25876816900098615, 0.2895530099646592,
        0.3239616722653205, 0.36243278914517174, 0.40546210631669705, 0.45361068250948355, 0.5075143756891303,
        0.5678948289918877, 0.6355722066374614, 0.7114799720118545, 0.7966820484211637, 0.8923927583520155,
        0.9999999999999994
    };

    // private void Start()
    // {
    //     HandleDataTexture();
    // }

    private void Update()
    {
        HandleDataTexture();
    }

    public void HandleDataTexture()
    {
        double[] coatToUse;

        switch (currentCoat)
        {
            case Coat.PerfectMirror:
                coatToUse = new double[273];
                for (int i = 0; i < coatToUse.Length; ++i)
                    coatToUse[i] = 1.0;
                break;
            case Coat.Coat1Layer:
                coatToUse = coat1layer;
                break;
            case Coat.Coat4Layer:
                coatToUse = coat4layer;
                break;
            default:
                Debug.LogError("Something went wrong");
                return; // return early
        }
        
        float[] coat = new float[coatToUse.Length];
        
        for (int i = 0; i < coat.Length; i++)
        {
            coat[i] = (float)coatToUse[i];
        }
        
        Texture2D dataTexture = CreateDataTexture(91, 1, coat, Format.RGB);
        renderer.sharedMaterial.mainTexture = dataTexture;
    }

    public Texture2D CreateDataTexture(int width, int height, float[] rawData, Format format)
    {
        Texture2D texture = new Texture2D(width, height);

        Color[] pixelData;
        if (format == Format.RGB)
        {
            int subLength = rawData.Length / 3;
            pixelData = new Color[subLength];

            for (int i = 0; i < pixelData.Length; ++i)
            {
                pixelData[i] = new Color(rawData[i], rawData[i + subLength], rawData[i + (2 * subLength)], 1);
            }
            
        }
        else
        {
            Debug.LogError("Invalid format");
            return null;
        }
        
        texture.SetPixels(pixelData);
        texture.Apply();
        //Debug.Log($"Applied data texture to material on renderer {renderer.name}");
        return texture;
    }
}